<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Category: notes - Bitisle</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="Bitisle"><meta name="msapplication-TileImage" content="img/logo.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Bitisle"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="512x512" href="img/logo.png"><meta name="description" content="一倍工程師的小天地"><meta property="og:type" content="blog"><meta property="og:title" content="Bitisle"><meta property="og:url" content="https://blog.bitisle.net/"><meta property="og:site_name" content="Bitisle"><meta property="og:description" content="一倍工程師的小天地"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.bitisle.net/img/open-graph.png"><meta property="article:author" content="Weida Hong"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.bitisle.net/img/open-graph.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.bitisle.net"},"headline":"Bitisle","image":["https://blog.bitisle.net/img/og_image.png"],"author":{"@type":"Person","name":"Weida Hong"},"publisher":{"@type":"Organization","name":"Bitisle","logo":{"@type":"ImageObject","url":"https://blog.bitisle.net/img/logo.png"}},"description":"一倍工程師的小天地"}</script><link rel="alternate" href="/atom.xml" title="Bitisle" type="application/atom+xml"><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="Bitisle" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a><a class="navbar-item search" title="Search" href="javascript:;" rel="external nofollow noreferrer"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">Categories</a></li><li class="is-active"><a href="#" aria-current="page">notes</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2025-02-26T01:05:00.000Z" title="2/26/2025, 1:05:00 AM">2025-02-26</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2025/02/26/cpp-generator-crtp.html">Easier Iteration with Generator</a></p><div class="content"><p>In Python, we can make a container type iterable by implement <code>__iter__</code> method.</p>
<p>For example, if we want to provide all value in a range <code>[lo, hi)</code> …</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TwoTillSix</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="number">6</span>):</span><br><span class="line">            <span class="keyword">yield</span> val</span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span>(TwoTillSix())  <span class="comment"># [2, 3, 4, 5]</span></span><br></pre></td></tr></table></figure>

<p>With the help of this generator function, we don’t need a separate iterator type.
Just keep the state during iteration directly in some local variable.</p>
<p>In this post, let’s see how we can do this in C++, with the help of <code>std::generator&lt;T&gt;</code>.</p>
<p>A shorter version of this post can be found in Gist and Compiler Explorer.</p>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://gist.github.com/wdhongtw/aa61b9b4dd132ffeae64d9189e9ba2cc">https://gist.github.com/wdhongtw/aa61b9b4dd132ffeae64d9189e9ba2cc</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://godbolt.org/z/K57Enfhcr">https://godbolt.org/z/K57Enfhcr</a></li>
</ul>
<h2 id="Coroutine-and-Concurrent-Programming"><a href="#Coroutine-and-Concurrent-Programming" class="headerlink" title="Coroutine and Concurrent Programming"></a>Coroutine and Concurrent Programming</h2><p>What happens in the example above is that Python interpreter binds the execution state of
that function to a generator object. Every time we want a value from that generator,
the execution resumes until the function yields the next value (or returns).</p>
<p>This is doable because Python provide a builtin support for <strong>coroutine, an interruptible&#x2F;resumable
function</strong>, so the control flow can interleave between callee and caller functions. And that’s the
primitive building block of concurrent programming.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">values = TwoTillSix()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> val <span class="keyword">in</span> values:</span><br><span class="line">    <span class="built_in">print</span>(val)</span><br><span class="line">    <span class="keyword">if</span> val == <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># Print 2 and 3. The body of `TwoTillSix.__iter__` is only executed twice.</span></span><br></pre></td></tr></table></figure>

<p>As we can see here, the generator makes it possible that some values are evaluated lazily,
and we can even stop the evaluation any time when we lost the interest.
All of this is possible because the support of coroutine.</p>
<h2 id="C-Coroutine-and-std-generator"><a href="#C-Coroutine-and-std-generator" class="headerlink" title="C++ Coroutine and std::generator"></a>C++ Coroutine and <code>std::generator</code></h2><p>Fortunately, C++ has language level support for coroutine since C++20.
When compiler see a function using new keywords <code>co_await</code> &#x2F; <code>co_yield</code> and <code>co_return</code>,
it will generate corresponding code to provide the ability of partial execution, and the storage
of state for that function when it’s interrupted.</p>
<p>Also, starting from C++23, <code>std::generator</code> is included in standard library. As the
coroutine (promise-)type that capture the common usage of… yes, generator!!
(Actually I’m surprised that there is no any high-level coroutine type in standard library
when coroutine is accepted as a language feature when C++20 is finalized.)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::generator&lt;<span class="type">int</span>&gt; <span class="title">fibonacci</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>, b = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">co_yield</span> a;</span><br><span class="line">        b = std::<span class="built_in">exchange</span>(a, a + b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> num : <span class="built_in">fibonacci</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (num &gt; <span class="number">10</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        std::<span class="built_in">println</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, num); <span class="comment">// prints 1 1 2 3 5 8</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When <code>fibonacci</code> is called here, an interruptible function is created, and wrapped in the
<code>std::generator</code> return value. Every time we take next value out in the for-loop, the function
resumes and yield next value (and is interrupted again).</p>
<p>So now we have the ability to interleave control flow, just like the example in Python earlier!!
But… that’s a free function, usually what we encounter is a container class.
A class must has <code>begin</code>&#x2F;<code>end</code> method, and corresponding increment&#x2F;dereference operator on
the returned iterator type, in order to be iterable.
(It’s modeled as named requirements <em>Container</em> in standard.)
If a class need another method call to be iterated on, it just looks… not like C++.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Factorial</span> &#123; <span class="comment">// a virtual container for factorial series</span></span><br><span class="line">    <span class="function">std::generator&lt;<span class="type">int</span>&gt; <span class="title">generate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> product = <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> val = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">co_yield</span> product;</span><br><span class="line">            product *= val++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Factorial fac &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> num : fac.<span class="built_in">generate</span>()) &#123; <span class="comment">// well.. can we iterate on fac directly?</span></span><br><span class="line">        <span class="keyword">if</span> (num &gt; <span class="number">10</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        std::<span class="built_in">println</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So… can we keep the implementation simple (using <code>std::generator</code> coroutine type),
while keeping the container being iterated in usual way?</p>
<h2 id="CRTP-Curiously-Recurring-Template-Pattern"><a href="#CRTP-Curiously-Recurring-Template-Pattern" class="headerlink" title="CRTP: Curiously Recurring Template Pattern"></a>CRTP: Curiously Recurring Template Pattern</h2><p>Now our goal become clear:</p>
<blockquote>
<p>How can we make a class be used as before, if the class only provides a method
that return a <code>std::generator</code>?”</p>
</blockquote>
<p>That’s the place where we adopt CRTP to solve problem.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @brief HasGenerator identifies the customization point of CRTP base AutoContainer.</span></span><br><span class="line"><span class="comment">/// @tparam C the child class type.</span></span><br><span class="line"><span class="comment">/// @tparam T the value type.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> C, <span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">concept</span> HasGenerator = <span class="built_in">requires</span>(C c) &#123;</span><br><span class="line">    &#123; c.<span class="built_in">generate</span>() &#125; -&gt; std::same_as&lt;std::generator&lt;T&gt;&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// @brief A CRTP base type that allow easy iteration implementation.</span></span><br><span class="line"><span class="comment">/// @tparam T the value type of element being iterated. Not child class type.</span></span><br><span class="line"><span class="comment">/// @details Child class must provide std::generator&lt;T&gt; generate() member function.</span></span><br><span class="line"><span class="keyword">template</span> &lt;std::semiregular T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AutoContainer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Iter</span> &#123;</span><br><span class="line">        std::generator&lt;T&gt; gen_;</span><br><span class="line">        std::ranges::<span class="type">iterator_t</span>&lt;std::generator&lt;T&gt;&gt; iter_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">Iter</span>(std::generator&lt;T&gt;&amp;&amp; gen)</span><br><span class="line">            : gen_ &#123; std::<span class="built_in">move</span>(gen) &#125; <span class="comment">// ensure generator being alive</span></span><br><span class="line">            , iter_ &#123; gen_.<span class="built_in">begin</span>() &#125; &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> std::<span class="type">default_sentinel_t</span>&amp;) <span class="type">const</span> &#123; <span class="keyword">return</span> iter_ == gen_.<span class="built_in">end</span>(); &#125;</span><br><span class="line">        Iter&amp; <span class="keyword">operator</span>++() &#123; <span class="keyword">return</span> ++iter_, *<span class="keyword">this</span>; &#125;</span><br><span class="line">        T <span class="keyword">operator</span>*() <span class="type">const</span> &#123; <span class="keyword">return</span> *iter_; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deducing-this so that we can do CRTP.</span></span><br><span class="line">    <span class="comment">// Also use concept to give better error message when doing mistake.</span></span><br><span class="line">    <span class="function">Iter <span class="title">begin</span><span class="params">(<span class="keyword">this</span> HasGenerator&lt;T&gt; <span class="keyword">auto</span>&amp;&amp; self)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Iter</span>(self.<span class="built_in">generate</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deducing-this not required, just be symmetric with begin.</span></span><br><span class="line">    <span class="function">std::<span class="type">default_sentinel_t</span> <span class="title">end</span><span class="params">(<span class="keyword">this</span> <span class="keyword">auto</span>&amp;&amp; self)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> std::default_sentinel;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>AutoContainer</code> can inherited by any class that want the all the implementation for iteration.
The base class here provides an iterator type to capture the generator, and forwards the
increment&#x2F;dereference operation to it. With this iterator type, the remain
effort is on the <code>begin</code> method, just construct the iterator from <code>self.generate()</code>.
Here <code>self</code> is typed by deducing-this so <code>generate()</code> can be provided later by child class.
And that’s the place where the base class connects to it’s child.</p>
<p>Also at the <code>begin</code> method, we add concept constrain <code>HasGenerator</code>.
This way we can avoid error waterfall when using templated library.
And the interesting thing here is: “The thing to be templated so that we achieve CRTP,
is the templated <code>begin</code> method, not the <code>AutoContainer</code> class itself.
If there are two child class both  inherit from <code>AuthContainer&lt;int&gt;</code>,
only one <code>AuthContainer</code> type is instantiated, but two different <code>begin</code> are instantiated.</p>
<p>(See also: <a target="_blank" rel="noopener external nofollow noreferrer" href="https://en.cppreference.com/w/cpp/language/crtp">Curiously Recurring Template Pattern - cppreference.com</a>)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @brief Factorial sequence generator.</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Factorial</span> : <span class="keyword">public</span> AutoContainer&lt;<span class="type">int</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Implement `generate` so this class can be iterated like a container.</span></span><br><span class="line">        <span class="function">std::generator&lt;<span class="type">int</span>&gt; <span class="title">generate</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">            <span class="comment">// The mutable state is the local variable of this coroutine,</span></span><br><span class="line">            <span class="comment">// so the method receiver can be const.</span></span><br><span class="line">            <span class="type">int</span> product = <span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> val = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">co_yield</span> product;</span><br><span class="line">                product *= val++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> Factorial fac &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> value : fac) &#123; <span class="comment">// noticed that we don&#x27;t call generate() here</span></span><br><span class="line">        <span class="keyword">if</span> (value &gt; <span class="number">10</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        std::<span class="built_in">println</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, value); <span class="comment">// prints 1, 1, 2, 6</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now we can use the <code>AutoContainer</code> by inherit it in any child class.
In the example above, <code>Factorial</code> inherit from <code>AutoContainer&lt;int&gt;</code> (since it generates integers).
All we need to do is implement the <code>generate</code> method. Being a coroutine, the logic is clean.</p>
<p>Now everything works and <strong>looks nice</strong>!! :D</p>
<p>To make this class recognized as a <code>std::ranges::input_range</code>, that is, to make this class
works with <code>&lt;ranges&gt;</code> library, the base <code>AutoContainer</code> actually need more stuffs, like
<code>value_type</code>&#x2F;<code>difference_type</code> on it’s iterator, support of post-increment operator, and so on…
But that’s probably too much in a tutorial, so let’s stop here.</p>
<h2 id="More-Standard-Library-Support-Maybe"><a href="#More-Standard-Library-Support-Maybe" class="headerlink" title="More Standard Library Support, Maybe?"></a>More Standard Library Support, Maybe?</h2><p>We describe the minimal concept about coroutine, one important application of coroutine as
Generator (<code>std::generator</code>), and how to use it in a beautiful way.
But there is another important application of coroutine: Promise (with Event Loop).</p>
<p>JS developers already get used to the <code>Promise</code> type (or maybe the <code>async</code>&#x2F;<code>await</code> keyword).
Python also support this kind of usage since Python 3.5.
But unfortunately, there is still no such thing in C++ standard library, even if the coroutine
is standardized in C++20.</p>
<p>The good news is that there is already a proposal P2300 and a reference implementation <code>NVIDIA/stdexec</code>.
(They don’t use the term Promise, probably because <code>promise_type</code> already have other meaning
in the context of C++ coroutine)</p>
<p>Hope we can see more usage about these in the future.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2025-02-04T14:10:00.000Z" title="2/4/2025, 2:10:00 PM">2025-02-04</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2025/02/04/javascript-proxy.html">The Backbone of Frontend Framework</a></p><div class="content"><p>It’s almost impossible to write a frontend without any UI framework nowadays.</p>
<p>All these frameworks provide some kind of mechanism that, whenever we change a value in JavaScript,
some element in UI will be changed automatically. For example, adding new row to a table
when we push a item into a list.</p>
<p>But how does this work under the surface?
That’s the <em>Proxy Object</em>.</p>
<hr>
<h2 id="Internal-Method-and-Proxy"><a href="#Internal-Method-and-Proxy" class="headerlink" title="Internal Method and Proxy"></a>Internal Method and Proxy</h2><p>We need to talk about <em>internal method</em> in JS first.</p>
<p>A <em>internal method</em> is a special method&#x2F;function that decide how a object behaves in JS runtime.
For example, <code>[[GET]]</code> internal method determines the result when we access some property <code>prop</code>
from an object <code>obj</code>, e.g. <code>obj.prop</code>. And <code>[[Call]]</code> internal method determines what to
proceed when we call the object <code>obj</code> as a function, e.g. <code>obj()</code>.</p>
<p>These internal methods can be intercepted and customized from some existing object,
with a <em>Proxy</em> instance.</p>
<p>For example, if we want to intercept the property-read action of some object. Here is the way to do.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Alice&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> agent = <span class="keyword">new</span> <span class="title class_">Proxy</span>(</span><br><span class="line">    person,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params">target, property, receiver</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`access &quot;<span class="subst">$&#123;property&#125;</span>&quot; as <span class="subst">$&#123;target[property]&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> target[property];</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ = agent.<span class="property">name</span>; <span class="comment">// prints: access &quot;name&quot; as Alice&quot;</span></span><br></pre></td></tr></table></figure>

<p>In the snippet above, <code>agent</code> is the proxy object instance.
The second argument to Proxy constructor is the <em>handler</em>, and the <code>get</code> function in that handler
is a <em>trap</em> to the <code>[[GET]]</code> internal method.</p>
<p>See </p>
<h2 id="The-set-Trap-for-Binding"><a href="#The-set-Trap-for-Binding" class="headerlink" title="The set Trap for Binding"></a>The <code>set</code> Trap for Binding</h2><p>Just like we can intercept the property <strong>read</strong> action for some object, we can also intercept
the property <strong>write</strong> action. And that’s what UI frameworks do underneath.</p>
<p>Assuming we have a paragraph in DOM tree, identified by id <code>greeting</code>.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;greeting&quot;</span>&gt;</span>Hi<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>We can ensure that the text is updated automatically when we are doing some
change to JavaScript object. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> element = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#greeting&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> handler = &#123;</span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span>(<span class="params">target, property, value, receiver</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (property !== <span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        target[property] = value;</span><br><span class="line">        element.<span class="property">textContent</span> = value; <span class="comment">// react to the change</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> greeting = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;<span class="attr">text</span>: element.<span class="property">textContent</span>&#125;, handler);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(greeting.<span class="property">text</span>); <span class="comment">// print &#x27;Hi&#x27;</span></span><br><span class="line">greeting.<span class="property">text</span> = <span class="string">&#x27;Hello&#x27;</span>;</span><br><span class="line"><span class="comment">// the text in the html page will be changed accordingly.</span></span><br></pre></td></tr></table></figure>

<p>Once this proxy object is created, we make the view (HTML) reactive to
the model (JavaScript object), and the binding is established.</p>
<hr>
<p>In the examples above, we may noticed that all the intercepted objects are an <em>object</em> literally.
That means we can not do similar thing to primitive type in JS, like <code>number</code> and <code>string</code>.
And that do have impact on the design of UI framework.
For example, Vue.js framework has a <a target="_blank" rel="noopener external nofollow noreferrer" href="https://vuejs.org/guide/essentials/reactivity-fundamentals#ref"><code>ref()</code></a> wrapper for that.</p>
<p>However, Proxy is still a powerful feature in JS, and probably the most important feature
for any senior engineer who need to work with JS.
So just get used to it. :D</p>
<p>See Also: <a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxy - MDN</a></p>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><p>Full HTML file for the view-model binding example.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Proxy Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;greeting&quot;</span>&gt;</span>Hi<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> element = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#greeting&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> handler = &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">set</span>: <span class="keyword">function</span>(<span class="params">target, property, value, receiver</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (property !== <span class="string">&#x27;text&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                    target[property] = value;</span></span><br><span class="line"><span class="language-javascript">                    element.<span class="property">textContent</span> = value; <span class="comment">// react to the change</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span> <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> greeting = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;<span class="attr">text</span>: element.<span class="property">textContent</span>&#125;, handler);</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(greeting.<span class="property">text</span>); <span class="comment">// print &#x27;Hi&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            greeting.<span class="property">text</span> = <span class="string">&#x27;Hello&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// the text in the html page will change accordingly.</span></span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-10-23T00:15:00.000Z" title="10/23/2024, 12:15:00 AM">2024-10-23</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/10/23/cpp-optional-monostate.html">There is No Unit Type in C++</a></p><div class="content"><p>There is NO unit type in C++. (Not in core language spec, at least.)</p>
<h2 id="A-Story"><a href="#A-Story" class="headerlink" title="A Story"></a>A Story</h2><p>Assuming we are define a abstract interface for storage to get name &#x2F; set name for some user.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Storage</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Storage</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">GetName</span><span class="params">(<span class="type">int</span> id)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetName</span><span class="params">(<span class="type">int</span> id, std::string name)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Simple and straightforward.</p>
<p>But it’s intended to be a storage accessed through network, so any operation on it is
inherently going to fail at some time.
Also, We are 2024 now, loving FP, preferring expression over statement, monadic operation
being so cool.
Thus we decide to wrap all return type in <code>std::optional</code> to indicate these actions may fail.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Storage</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Storage</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::optional&lt;std::string&gt; <span class="title">GetName</span><span class="params">(<span class="type">int</span> id)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::optional&lt;<span class="type">void</span>&gt; <span class="title">SetName</span><span class="params">(<span class="type">int</span> id, std::string name)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Looks good! But now it fails to be compiled.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...\include\optional(100,26): error C2182: &#x27;_Value&#x27;: this use of &#x27;void&#x27; is not valid</span><br></pre></td></tr></table></figure>

<p>Well. template stuff.</p>
<h2 id="What-Happened"><a href="#What-Happened" class="headerlink" title="What Happened?"></a>What Happened?</h2><p>The problem is that <code>void</code> is an incomplete type in C&#x2F;C++, and always to be treat specially
when we are trying to use them.</p>
<p>By incomplete in C&#x2F;C++, we mean a type that the size of which is not (yet) known.</p>
<p>For example, if we forward declare a struct type, and later define it’s member. The struct type
is incomplete before the definition.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Item</span>;</span><br><span class="line"></span><br><span class="line">Item item; <span class="comment">// &lt;- invalid usage, since that the size of Item is unknown yet.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Item</span> &#123;</span><br><span class="line">    <span class="type">int</span> price;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Item item; <span class="comment">// &lt;- valid usage here.</span></span><br></pre></td></tr></table></figure>

<p>And <code>void</code> is a type that is impossible to be complete by specification.</p>
<p>But we can have a function that return <code>void</code>?
Well, we return <em>nothing</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span>; &#125; <span class="comment">// Or explicit return, both equivalent.</span></span><br></pre></td></tr></table></figure>

<p>BTW, C before C23 prefer putting a <code>void</code> in parameter list to indicate that a function takes
<em>nothing</em>, e.g. <code>int bar(void)</code>, but is’s kinda broken design here.</p>
<p>Since that we can not evaluate <code>bar(foo())</code>. There is no such thing that is a <code>void</code> and exists.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">bar</span><span class="params">(<span class="type">void</span>)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bar</span>(<span class="built_in">foo</span>()); <span class="comment">// &lt;- invalid expression here.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So back to our problem here <code>std::optional&lt;void&gt;</code></p>
<p>Conceptually, <code>std::optional&lt;T&gt;</code> is just a some T with additional information of <em>value-existence</em>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyOptional</span> &#123;</span><br><span class="line">    T value;</span><br><span class="line">    <span class="type">bool</span> hasValue;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Because that there is impossible to have a member <code>void value</code>,
<code>std::optional&lt;void&gt;</code> is not going to be a valid type at first place.</p>
<p>(Well, we can make a specialization for <code>void</code>, but that’s another story.)</p>
<h2 id="So-How-can-We-Fix"><a href="#So-How-can-We-Fix" class="headerlink" title="So, How can We Fix?"></a>So, How can We Fix?</h2><p>The problem here is that there is no a valid value for <code>void</code> in C&#x2F;C++.
At some level, program can be though of a bunch of expressions. An running a program
is just the evaluation of these expressions. (Also the side effects, for real products &#x2F; services)</p>
<p>The atom of expression is value. If there is a concept that’s not possible to be express
as a value, we are kicking ourselves.</p>
<p>Take Python for example, if we have a function that return nothing, then the function actually
<strong>returns</strong> <code>None</code> when it exits.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(foo() <span class="keyword">is</span> <span class="literal">None</span>) <span class="comment"># check pass here</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">arg: <span class="literal">None</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bar</span>(<span class="params">arg: <span class="literal">None</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">bar(foo(<span class="literal">None</span>)) <span class="comment"># well.. if we really want to chain them together</span></span><br></pre></td></tr></table></figure>

<p>So <em>nothing</em> itself is a thing, in Python, we call it <code>None</code>.
Every expression now is evaluated to some value that exists, the the type system build up that
is complete at any case.</p>
<p>The concept of <em>nothing</em> itself here is call <strong>unit type</strong> in type theory.
It’s a type that has one and only one value.
In Python, the value is <code>None</code>, in JavaScript it’s <code>null</code>, in Golang … maybe <code>struct&#123;&#125;&#123;&#125;</code> is a
good choice, although not standardized by the language.</p>
<h2 id="Unit-Type-in-C"><a href="#Unit-Type-in-C" class="headerlink" title="Unit Type in C++"></a>Unit Type in C++</h2><p>Now is the time for C++. As we already see, <code>void</code> is not a good choice for unit type because we
can not have a value for it. Are there other choices here?</p>
<p>Just define a empty struct and use it probably not a good choice, since that
now our custom unit type is not compatible with unit type from other code in the product code base.</p>
<p>How about <code>nullptr</code>, that’s the only one value for <code>std::nullptr_t</code>.
(So the type is <code>std::optional&lt;std::nullptr_t&gt;</code>).
It’s a feasible choice, but looks weird since that pointer implies indirect access semantic,
but it’s not the case when using with <code>std::optional&lt;T&gt;</code> here.</p>
<p>How about using <code>std::nullopt_t</code>? It’s also a unit type but it’s now more confusing.
What’s does it mean by <code>std::optional&lt;std::nullopt_t&gt;</code>? A optional with empty option?
There is a static assert in <code>std::optional&lt;T&gt;</code> template that forbid this usage directly,
probably because it’s too confusing.</p>
<p>Maybe <code>std::tuple&lt;&gt;</code>? A tuple with zero element, so it have only one value, the empty tuple.
That seems to be a good choice because the canonical unit type in Haskell is <code>()</code> the empty tuple.
So it looks natural for people came from Haskell.
But personally I don’t like this either since that now the type has nested angle bracket
as <code>std::optional&lt;std::tuple&lt;&gt;&gt;</code>.</p>
<p>There is a type called <code>std::monostate</code>, arrived at the same time as <code>std::optional</code> in C++17.
This candidate do not have additional implication by it’s type or it’s name.
It’s <em>monostate</em>! Just a little wordy.</p>
<p><code>std::monostate</code> is originally designed to solve the problem for a <code>std::variant&lt;...&gt;</code> to be
default initialized with any value. But it’s name and it’s characteristic are all fit our
requirement here. Thus a good choice for wrapping a function that may fail but
return nothing.</p>
<p>Now the interface looks like</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Storage</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Storage</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::optional&lt;std::string&gt; <span class="title">GetName</span><span class="params">(<span class="type">int</span> id)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::optional&lt;std::monostate&gt; <span class="title">SetName</span><span class="params">(<span class="type">int</span> id, std::string name)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Hmm… <code>std::optional&lt;std::monostate&gt;</code>, which takes 29 characters.
C++ is not easy. Just like we use <code>std::shared_ptr&lt;T&gt;</code> all over the places.</p>
<p>Maybe the C++ Standards Committee should specialize <code>std::optional&lt;void&gt;</code>,
just like <code>std::expected&lt;void&gt;</code> in C++23.</p>
<hr>
<p>Wish someday <code>void</code> can be a REAL unit type in C&#x2F;C++. :D</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-22T09:05:34.000Z" title="8/22/2024, 9:05:34 AM">2024-08-22</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/08/22/golang-iterator-functions.html">Golang 1.23 Iterator Functions</a></p><div class="content"><p>For a long long long time, Golang have no standard way to represent a iterable sequence.</p>
<p>C++ has range adaptor and iterator (although not strictly typed, only by concept), Python has
iterable&#x2F;iterator by <code>__iter__</code>&#x2F;<code>__next__</code>, JavaScript has standardized <code>for-of</code> and
<code>Symbol.iterator</code> since ES6.</p>
<p>Now it’s time for Golang. Starting from Golang 1.23 Aug., we have <strong>iterator functions</strong>.</p>
<h2 id="How-It-Works"><a href="#How-It-Works" class="headerlink" title="How It Works."></a>How It Works.</h2><p>Sample code explains faster.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Iota</span><span class="params">()</span></span> <span class="function"><span class="keyword">func</span><span class="params">(yield <span class="keyword">func</span>(idx <span class="type">int</span>)</span></span> <span class="type">bool</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(yield <span class="keyword">func</span>(idx <span class="type">int</span>)</span></span> <span class="type">bool</span>) &#123;</span><br><span class="line">		idx := <span class="number">0</span></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> !yield(idx) &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			idx += <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> idx := <span class="keyword">range</span> Iota() &#123;</span><br><span class="line">		<span class="keyword">if</span> idx == <span class="number">3</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(idx) <span class="comment">// print 0 1 2</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>According to <a target="_blank" rel="noopener external nofollow noreferrer" href="https://go.dev/doc/go1.23">Go 1.23 Release Notes</a>
Now the <code>range</code> keyword accept three kinds of functions, for which takes another <code>yield</code> function
that yield zero&#x2F;one&#x2F;two values.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">func</span>()</span></span> <span class="type">bool</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">func</span>(K)</span></span> <span class="type">bool</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">func</span>(K, V)</span></span> <span class="type">bool</span>)</span><br></pre></td></tr></table></figure>

<p>The loop control variable and the body of the for-loop is translated into the <code>yield</code> function by
language definition. So we can still write imperative-style loop structure even though we are
actually doing some functional-style function composition here.</p>
<h2 id="Why-Do-We-Need-This"><a href="#Why-Do-We-Need-This" class="headerlink" title="Why Do We Need This?"></a>Why Do We Need This?</h2><p>Standardize the iterable&#x2F;iterator interface is a important pre-condition for lazy evaluation.
For example, how should we do when we need to iterates through all non-negative integer,
and doing some map&#x2F;filter&#x2F;reduce on them?  It waste space to allocate a list for all these
integers (if possible).</p>
<p>Someone may say “we already have channel types”.
Well, but that requires a separate coroutine instance. We probably don’t want such heavy
cost every time we are doing some iterate operations.</p>
<p>Also a separate coroutine means additional synchronization and lifecycle control.
For example, how can we terminate the <code>Count</code> coroutine when we need early break in loop?</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Count</span><span class="params">(start <span class="type">int</span>)</span></span> <span class="keyword">chan</span> <span class="type">int</span> &#123;</span><br><span class="line">	output := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		idx := start</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			output &lt;- idx</span><br><span class="line">			idx += <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">return</span> output</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> idx := <span class="keyword">range</span> Count(<span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> idx == <span class="number">10</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Loop: &quot;</span>, idx)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We need some mechanism like context object or another channel right?
That’s a burden for such easy task here.</p>
<p>On the other hand, <strong>iterator functions</strong> are just ordinary function that accept another function
to yield&#x2F;output the iterated values, so it’s much lightweight than a separate coroutine.
We want fast program, right? :D</p>
<h2 id="The-Stop-Design"><a href="#The-Stop-Design" class="headerlink" title="The Stop Design"></a>The Stop Design</h2><p>For languages like Python and JavaScript, the iterator function (or generator in Python terms)
is paused and the control is transfer back to the function that iterates the values.
When <code>break</code>&#x2F;<code>return</code> happens and no more value are required, the iterator function just
got collected by the runtime since that there are no more references to the function object.</p>
<p>But how do we early break the iteration process, if the control is transfer
into the iterator function? Let’s look at the function signature again.
(Take one value iterator function for example).</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(yield <span class="keyword">func</span>(idx <span class="type">int</span>)</span></span> <span class="type">bool</span>)</span><br></pre></td></tr></table></figure>

<p>The <code>yield</code> function returns a <code>bool</code> to indicate that whether the loop body does reach the
end, or encounter a <code>break</code> statement. So in normal case, we continue to next possible value
after <code>yield</code> return, but if we got <code>false</code> from <code>yield</code>, our iterator function
can return immediately. </p>
<h2 id="Ecosystem-around-Iterator"><a href="#Ecosystem-around-Iterator" class="headerlink" title="Ecosystem around Iterator"></a>Ecosystem around Iterator</h2><p>The beauty of iterator only appears if the ecosystem, or we say, the common operations around
iterator are already implemented in standard library. That means:</p>
<ul>
<li>Conversion from and to standard container types, like <code>slice</code> <code>map</code> and <code>chan</code></li>
<li>Operations and compositions of iterators, e.g. <code>map</code>&#x2F;<code>filter</code>&#x2F;<code>reduce</code>&#x2F;<code>chain</code>&#x2F;<code>take</code> …</li>
</ul>
<p>In Python, there are generator expressions, which evolves implicit <code>map/filter</code>.
<code>reduce</code> is a function at global scope, also there are many useful functions in <code>itertools</code> package,
e.g. <code>pairwise</code>, <code>batched</code>, <code>chain</code>. Most builtin container types takes iterable as first argument
in it’s constructor.</p>
<p>In Golang, the first part is mostly done along the release of Golang 1.23.
For example, to convert slice from and to iterator, we can use <code>slices.Collect</code> and <code>slices.Values</code>.</p>
<p>For second part, there is a plan to add <code>x/exp/xiter</code> package under <code>golang.org</code> namespace.
There should be at least <code>Concat</code>, <code>Map</code>, <code>Filter</code>, <code>Reduce</code>, <code>Zip</code> … once it’s released.
But unfortunately it’s not compete yet.</p>
<p>See: <a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/61897">iter: new package for iterators · Issue #61897 · golang&#x2F;go</a></p>
<p>Also I create a toy package <a target="_blank" rel="noopener external nofollow noreferrer" href="https://pkg.go.dev/github.com/wdhongtw/mice/flow">github.com&#x2F;wdhongtw&#x2F;mice&#x2F;flow</a>
to address some important building wheel around iterators</p>
<ul>
<li><code>Empty</code>&#x2F;<code>Pack</code> return a iterator for zero&#x2F;one value</li>
<li><code>Any</code>&#x2F;<code>All</code> short-circuit lazy evaluation of a predicate on a sequence of values</li>
<li><code>Forward</code>&#x2F;<code>Backward</code> absorb input and iterate in reversed order.</li>
</ul>
<p>For example, if we want to define a iterator function for a binary tree in recursive manner,
we can use <code>Empty</code> and <code>Pack</code> together with <code>Chain</code> to implement this easily.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123;</span><br><span class="line">    val   <span class="type">int</span></span><br><span class="line">    left  *Node</span><br><span class="line">    right *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Traverse</span><span class="params">(node *Node)</span></span> iter.Seq[<span class="type">int</span>] &#123;</span><br><span class="line">    <span class="comment">// Empty is useful as base case during recursive generator chaining.</span></span><br><span class="line">    <span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Empty[<span class="type">int</span>]()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Pack is useful to promote a single value into a iterable for chaining.</span></span><br><span class="line">    <span class="keyword">return</span> Chain(</span><br><span class="line">        Traverse(node.left),</span><br><span class="line">        Pack(node.val),</span><br><span class="line">        Traverse(node.right),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Looks cool, doesn’t it? :D</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-06-05T09:38:00.000Z" title="6/5/2024, 9:38:00 AM">2024-06-05</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/06/05/python-type-expression.html">Python 的 type 不是 type？</a></p><div class="content"><h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>近期因為一些原因，想自己寫一個 Python 用的 DI library。寫是寫完了，不含 test 基本上不到 50 行，
也 release 到 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://pypi.org/project/luckydep/">luckydep · PyPI</a> 了。
不過在寫的過程中發現了一些問題。</p>
<p>與 Golang 不同。 在 Python 中，DI container 拿取特定 instance 的介面 (invoke&#x2F;bind&#x2F;get 等，下稱 invoke)
需要明確傳遞想拿取的 instance 的 type。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Invoke</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(c *Container)</span></span> T &#123;</span><br><span class="line">    <span class="keyword">var</span> _ T <span class="comment">// can construct T event if T is a interface</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// although we need to specify the type parameter, the type parameter</span></span><br><span class="line"><span class="comment">// is not passed during runtime</span></span><br><span class="line"><span class="keyword">var</span> instance = Invoke[SomeType](c)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Container</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invoke</span>(<span class="params">t</span>): <span class="comment"># search and build a instance of type t</span></span><br><span class="line"></span><br><span class="line">c = Container()</span><br><span class="line">instance = c.invoke(SomeType) <span class="comment"># need to pass type as a parameter</span></span><br></pre></td></tr></table></figure>

<p>其中的根本差異是，Golang 類型的 static type language，generic function 會真的根據不同型別，產生對應的
function 出來，這些 function 的 byte code&#x2F;machine code 自然知道當下在處理的型別。
而 Python 這類語言，靠 static type checker 建立 generic function，實際上到 runtime 時還是只有一個
function，自然會需要傳遞 type 給 invoke 介面。</p>
<p>自從 Python 3.6 開始我們有 type hint，所以我們可以 annotate function&#x2F;method 來幫助
IDE&#x2F;type checker 來推論正確的型別。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Container</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invoke</span>(<span class="params">t: <span class="built_in">type</span>[T]</span>) -&gt; T: <span class="comment"># search and build a instance of type t</span></span><br><span class="line"></span><br><span class="line">c = Container()</span><br><span class="line">instance: SomeType = c.invoke(SomeType) <span class="comment"># ok, we can infer instance is SomeType</span></span><br></pre></td></tr></table></figure>

<p>這邊 <code>type[T]</code> (or <code>typing.Type[T]</code>, the old way) 用來表示我們正在用 <code>t</code> 來傳遞傳遞某個 type <code>T</code>，
而非 type 為 <code>T</code> 的某個 instance。</p>
<p>From <code>typing</code> document:</p>
<blockquote>
<p>A variable annotated with <code>C</code> may accept a value of type <code>C</code>. In contrast, a variable annotated with
<code>type[C]</code> (or <code>typing.Type[C]</code>) may accept values that are classes themselves</p>
</blockquote>
<h2 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h2><p>OK，我們有 <code>type[T]</code> 可以用。 DI library 開發者可以用型別為 <code>type[T]</code> 的 <code>t</code> 來做 indexing，
library 使用者可以享受到 static type checker 帶來的 type safety。</p>
<p>於是我們拿這個 library 來用在真實情境.. 沒想到一下子就碰上問題了。
當我們定義 interface type，並透過 DI container 對該 interface 拿取對應的 implementation instance 時。
因為 interface 通常是個 abstract class (or protocol)，<code>mypy</code> type checker 會報錯
(<a target="_blank" rel="noopener external nofollow noreferrer" href="https://mypy.readthedocs.io/en/stable/error_code_list.html#safe-handling-of-abstract-type-object-types-type-abstract">mypy: type-abstract</a>)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SomeInterface</span>(<span class="title class_ inherited__">Protocol</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hello</span>(<span class="params">self</span>): ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SomeImplementation</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hello</span>(<span class="params">self</span>): ...</span><br><span class="line"></span><br><span class="line">c.invoke(SomeInterface) <span class="comment"># trigger mypy error [type-abstract]</span></span><br></pre></td></tr></table></figure>

<p>不會吧… 這不是我們需要 DI 的最重要原因嗎？
我們定義 interface 並另外提供 implementation，來達到隔離不同 class 職責的效果。
結果當 user 要用這個 library 的時候卻卡在型別檢查…</p>
<h2 id="The-History"><a href="#The-History" class="headerlink" title="The History"></a>The History</h2><p>翻閱文件，第一時間以為這是 <code>mypy</code> 的設計問題。</p>
<blockquote>
<p>Mypy always allows instantiating (calling) type objects typed as <code>Type[t]</code></p>
</blockquote>
<p>沒想到翻了 <code>mypy</code> issue <a target="_blank" rel="noopener" href="https://github.com/python/mypy/issues/4717">#4717 · python&#x2F;mypy</a>
後，發現這是已經寫在 PEP 544 內的規格。</p>
<blockquote>
<p>Variables and parameters annotated with <code>Type[Proto]</code> accept only concrete (non-protocol) subtypes of Proto.
The main reason for this is to allow instantiation of parameters with such type. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fun</span>(<span class="params">cls: <span class="type">Type</span>[Proto]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> cls().meth() <span class="comment"># OK</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><code>mypy</code> 允許 construct 一個不知道 constructor 長什麼樣子的 interface type，
所以該標示 <code>Type[Proto]</code> 的 parameter 只能傳遞 concrete type… 嗯？</p>
<p>繼續往下追，想不到一開始會有這個檢查，是因為 <strong>Guido 本人</strong> 在 2016 年開的 <a target="_blank" rel="noopener" href="https://github.com/python/mypy/issues/1843">#1843 · python&#x2F;mypy</a>，
認為應該允許這種使用方法。</p>
<p>於是 <code>mypy</code> 加入了這個檢查，後來 2017 年的 PEP 544 也明確定義了這個使用規則。</p>
<h2 id="The-Controversy"><a href="#The-Controversy" class="headerlink" title="The Controversy"></a>The Controversy</h2><p>這個 <code>t: type[T]</code> 的設計引起很多爭議，從 <a target="_blank" rel="noopener" href="https://github.com/python/mypy/issues/4717">#4717 · python&#x2F;mypy</a>
來看，不少人認為: 為了允許 construct <code>t()</code> 而限制只能傳遞 concrete class 會大幅限制這個 <code>type[T]</code> 的使用情境。</p>
<p>也有人認為這個檢查根本就不合理，因為沒有人能保證這個 protocol type 底下的 concrete class 的 constructor
到底要吃什麼東西。 即使 static type check 檢查過了，<code>t()</code> 在 runtime 噴掉一點也不奇怪。
更何況根本沒看過有人在 protocol type 上面定義 <code>__init__</code> method，這個 <code>t()</code> 一開始到底要怎麼檢查也不知道。</p>
<p>如果看相其他語言的開發經驗…
Golang 生態系 constructor 是 plain function，定義 interface type 時自然不會包含 constructor。
寫 C++ 的人應該也沒聽過什麼 abstract constructor，只有 destructor 會掛 <code>abstract</code> keyword。
回到 Python 自身，<code>mypy</code> 和 <code>pyright</code> 兩大工具也都允許 <code>__init__</code> 的 signature 在繼承鍊中被修改。
(see: <a target="_blank" rel="noopener" href="https://github.com/python/typing/discussions/1305">python&#x2F;typing · Discussion #1305</a>)</p>
<p>至於 <code>typing.Type</code> 的文件，寫得很模糊，我想有一定程度的人看到反而更容易誤會。</p>
<blockquote>
<p><code>type[C]</code> … may accept values that are classes themselves …</p>
</blockquote>
<p>就算捨棄掉 protocol，限制都只能用 concrete class 來定義 interface。
這個只能允許 concrete class 的規則還造成了另一個問題: 使用者該如何傳遞 function type？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.register(<span class="type">Callable</span>[[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>], <span class="keyword">lambda</span> a, b: a + b) <span class="comment"># ????</span></span><br></pre></td></tr></table></figure>

<p>說好的 function as first-class citizen 呢？ 怎麼到了要傳遞型別時就不行了？</p>
<p>在翻閱 issue 的過程中，發現其他 DI framework 的 repo 也遇上同樣的問題 <a target="_blank" rel="noopener" href="https://github.com/python-injector/injector/issues/143">#143 · python-injector&#x2F;injector</a>，
頓時覺得自己不孤單。</p>
<h2 id="The-Future"><a href="#The-Future" class="headerlink" title="The Future"></a>The Future</h2><p>由於 PEP 544 自從 2017 年就已經完成，<code>mypy</code> 預設執行這個檢查也行之有年，
現在再來改這個行為或許已經來不及了。</p>
<p>於是為了解決這個問題，2020 有人在開了新 issue <a target="_blank" rel="noopener" href="https://github.com/python/mypy/issues/9773">9773 · python&#x2F;mypy</a>
想要定義新的 annotation <code>TypeForm[T]</code>&#x2F;<code>TypeExpr[T]</code> 來達成要表達任意 type 的 type 的需求。
到目前 (2024-06)，對應的 <a target="_blank" rel="noopener" href="https://github.com/python/peps/pull/3798">PEP 747 draft</a> 也已經被提出了。</p>
<p>若一切順利，以後我們就會用 <code>TypeExpr[T]</code> 來表達這類 generic function</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Container</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invoke</span>(<span class="params">t: TypeExpr[T]</span>) -&gt; T: <span class="comment"># search and build a instance of type t</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SomeType</span>(<span class="title class_ inherited__">Protocol</span>): ...</span><br><span class="line"></span><br><span class="line">c = Container()</span><br><span class="line">instance = c.invoke(SomeType) <span class="comment"># ok, we find a object for type SomeType for you!</span></span><br><span class="line">operator = c.invoke(<span class="type">Callable</span>[[<span class="built_in">int</span>], <span class="built_in">bool</span>]) <span class="comment"># you need a (int -&gt; bool)? no problem!</span></span><br></pre></td></tr></table></figure>

<p>至於目前嘛.. library user 在使用到這類 library 的檔案加入下面這行即可。
我想要修改的範圍和造成的影響應該都還可以接受。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mypy: disable-error-code=&quot;type-abstract&quot;</span></span><br></pre></td></tr></table></figure>

<p>期許 Python typing system 完好的那天到來。</p>
<h2 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h2><ul>
<li>2016-07: <a target="_blank" rel="noopener" href="https://github.com/python/mypy/issues/1843">#1843 · python&#x2F;mypy</a> Guido 提出要 instantiate 的需求</li>
<li>2017-05: <a target="_blank" rel="noopener external nofollow noreferrer" href="https://peps.python.org/pep-0544/">PEP 544</a> standardized and published</li>
<li>2018-05: <a target="_blank" rel="noopener" href="https://github.com/python/mypy/issues/4717">#4717 · python&#x2F;mypy</a> first discussion against <code>type[T]</code> design</li>
<li>2020-04: <a target="_blank" rel="noopener" href="https://github.com/python-injector/injector/issues/143">#143 · python-injector&#x2F;injector</a></li>
<li>2020-10: <a target="_blank" rel="noopener" href="https://github.com/python/mypy/issues/9773">#9773 · python&#x2F;mypy</a> propose idea of <code>TypeFrom[T]</code></li>
<li>2024-06: <a target="_blank" rel="noopener" href="https://github.com/python/peps/pull/3798">PEP 747</a> draft created</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-03-16T14:54:00.000Z" title="3/16/2022, 2:54:00 PM">2022-03-16</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/16/golang-generics-coming.html">Golang 1.18 Generics 終於來臨</a></p><div class="content"><p>今天 Golang 1.18 終於正式釋出啦！
我們終於有辦法在 Golang 裡做 generic programming 啦！</p>
<p>Golang 是一個近 10 年快速竄紅的程式語言，但在很多面向其實還是非常土炮。
得靠後續社群不斷的討論與貢獻才達到一個比較完善的水準。 像是..</p>
<ul>
<li><code>context</code> package in Golang 1.7: 解決 long job cancelling 的問題</li>
<li><code>errors</code> package in Golang 1.13: 滿足其他語言常見的 error 嵌套需求和提供統一的判斷方式</li>
<li>Generic support in Golang 1.18: 提供開發者實作各種型無關演算法的機會</li>
</ul>
<p>一直以來，在 Golang 的標準函式庫中，碰到類型無關的抽象問題時，最後給出來的解法大概就兩種</p>
<ol>
<li>所有 input &#x2F; output 參數都定義成 <code>interface&#123;&#125;</code>，大家一起把型別檢查往 run-time 丟</li>
<li>同一個 class &#x2F; function 對於常用的 data type 通通實作一遍</li>
</ol>
<p>前者最典型的大概就是 <code>sync</code> 這個函示庫，後者.. 大家應該都看過那個慘不忍睹的 <code>sort</code>..</p>
<p>不過這些都是過去式了，從今天開始，大家都可以寫自己想要的 generic code &#x2F; library &#x2F; framework。 :D</p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>基本語法很簡單，只要在想做成 generic 的 function &#x2F; struct 後面多加一個 <code>[T TypeName]</code> 即可，
<code>TypeName</code> 是用原本就有的 <code>interface&#123;...&#125;</code> 語法來表示，可以自己描述這個 generic function &#x2F; struct
支援的型態必須滿足什麼樣的介面。</p>
<p>以 Python style 的 sort by key 當例子。
我們可以定義一個 generic 的 sort function，並且明定送進來的 list 內的每個元素需要支援一個 <code>Key</code> 函示，
作為排序時的根據。</p>
<p>範例 code 如下</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Keyable <span class="keyword">interface</span> &#123;</span><br><span class="line">	Key() <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span>[<span class="title">T</span> <span class="title">Keyable</span>]<span class="params">(items []T)</span></span> []T &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(items) &lt;= <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> items</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pivot := items[<span class="number">0</span>]</span><br><span class="line">	less, greater := []T&#123;&#125;, []T&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, item := <span class="keyword">range</span> items[<span class="number">1</span>:] &#123;</span><br><span class="line">		<span class="keyword">if</span> item.Key() &lt; pivot.Key() &#123;</span><br><span class="line">			less = <span class="built_in">append</span>(less, item)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			greater = <span class="built_in">append</span>(greater, item)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">append</span>(<span class="built_in">append</span>(less, pivot), greater...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n Person)</span></span> Key() <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> n.Age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	persons := []Person&#123;&#123;Name: <span class="string">&quot;alice&quot;</span>, Age: <span class="number">33</span>&#125;, &#123;Name: <span class="string">&quot;bob&quot;</span>, Age: <span class="number">27</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">	persons = Sort(persons)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在這個範例中，<code>Sort</code> 要求送進來的 <code>[]T</code> 當中的 <code>T</code> 要實作 <code>Keyable</code> 介面 (提供 <code>Key</code> method)。
當我們想排序一堆 <code>Person</code> 時，我們可以在這個 <code>Person</code> 物件上定義 <code>Key</code> method，取出 <code>Person</code> 的年齡。
完成之後，我們就可以依年齡來排序 <code>[]Person</code> 了。</p>
<p>期許自己未來可以多加利用這個遲來的功能.. XD</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://tip.golang.org/doc/go1.18">Go 1.18 Release Notes</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://go.dev/doc/tutorial/generics">Tutorial: Getting started with generics</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-08-08T03:52:24.000Z" title="8/8/2021, 3:52:24 AM">2021-08-08</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/08/08/single-node-ceph-cluster.html">單台機器的 Ceph 部署</a></p><div class="content"><h2 id="原由"><a href="#原由" class="headerlink" title="原由"></a>原由</h2><p>Ceph 的預設設定對資料的 replica 行為要求嚴格。
若只有單台機器或是硬碟數量受限，往往架設起來的 Ceph 無法順利存放資料。</p>
<p>此篇筆記關注的目標如下</p>
<blockquote>
<p>若想要用最少資源，建立可用的 Ceph 環境，需要做哪些額外的調整？</p>
</blockquote>
<h2 id="背景知識"><a href="#背景知識" class="headerlink" title="背景知識"></a>背景知識</h2><p>Ceph 是一套開源的儲存叢集 solution。 可以整合多個儲存設備並在其上提供
RADOSGW, RBD, Ceph FS 等不同層級的存取介面。</p>
<p><img src="https://docs.ceph.com/en/latest/_images/stack.png" alt="ceph-stack"></p>
<p>對於每個儲存設備 (HDD, SSD)，Ceph 會建立對應的 OSD 來管理儲存設備。
有了儲存設備之後，Ceph 會建立邏輯上的 pool 作為管理空間的單位。
Pool 底下會有多個 PG(placement group) 作為實際存放資料至 OSD 中的區塊。</p>
<p>在 Ceph 的預設設定中，一般 pool 的 replica 行為如下</p>
<ul>
<li>要有三份 replica</li>
<li>replica 要分散在不同的 host 上</li>
</ul>
<p>在開發環境中，資料掉了其實並無傷大雅，三份 replica 意味著儲存空間的浪費。
且若資料真的要放在不同的 host 上，連同 replica 三份這點，我們就至少要開三台機器，
增加無謂的管理成本。</p>
<h2 id="解決方式"><a href="#解決方式" class="headerlink" title="解決方式"></a>解決方式</h2><p>假設我們都是透過 <code>cephadm bootstrap</code> 來架設 Ceph。</p>
<p>Ceph cluster 建立好，也設定完需要的 OSD 之後，就可以來建立 pool。</p>
<p>根據 pool 的目的不同，要解決單台機器部署 Ceph 的限制，大概會有兩種做法。</p>
<h3 id="降低-Pool-Size"><a href="#降低-Pool-Size" class="headerlink" title="降低 Pool Size"></a>降低 Pool Size</h3><p>Pool size 此術語意味著該 pool 下的 PG 要 replica 幾份。
若某 pool 是拿供他人存放資料，或是會使用較多空間的，可以把 size 降為 1。</p>
<p>調整完之後就相當於該 pool 內的所有資料都不會有 replica。</p>
<p>範例如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create &quot;&lt;pool name&gt;&quot;</span><br><span class="line">ceph osd pool set &quot;&lt;pool name&gt;&quot; size 1</span><br><span class="line">ceph osd pool application enable &quot;&lt;pool name&gt;&quot; rbd</span><br></pre></td></tr></table></figure>

<h3 id="調整-Choose-Leaf-行為"><a href="#調整-Choose-Leaf-行為" class="headerlink" title="調整 Choose Leaf 行為"></a>調整 Choose Leaf 行為</h3><p>Ceph 有定義不同層級的資料分散設定。
預設值為 <code>host</code>，意味著只有一台機器的情況下，資料會無法複製。
若調整為 <code>osd</code>，只要該機器上有多顆硬碟即可滿足複製條件。
若是針對 Ceph 自行建立出來，管理 meta data 的 pool (e.g. <code>device_health_metrics</code>)
可以考慮使用此方式處理。</p>
<p>設定方式大概有兩種。</p>
<p><strong>方法一</strong>: 調整 Ceph global 設定</p>
<p>編輯 <code>/etc/ceph.conf</code> 並在 global section 下加入 <code>osd_crush_chooseleaf_type</code> 設定</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">...</span><br><span class="line">    osd_crush_chooseleaf_type = 0</span><br></pre></td></tr></table></figure>

<p>或是直接執行 command</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph config set global osd_crush_chooseleaf_type 0</span><br></pre></td></tr></table></figure>

<p>這邊的 <code>0</code> 代表 OSD。預設的對應列表如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type 0 osd</span><br><span class="line">type 1 host</span><br><span class="line">...</span><br><span class="line">type 9 zone</span><br><span class="line">type 10 region</span><br><span class="line">type 11 root</span><br></pre></td></tr></table></figure>

<p><strong>方法二</strong>: 修改 crush map 內容</p>
<p>筆者有注意到有時即使有執行方法一，pool 還是不會受到設定影響。 (相關知識還太少，
不太確定具體原因) 不過針對此狀況，還有第二個方法可以使用。</p>
<p>此方法會用到 <code>crushtool</code> 指令 (Ubuntu 中需要額外安裝 <code>ceph-base</code> 套件)</p>
<p>首先執行指令將目前的 crush map 撈出來</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph osd getcrushmap -o &quot;compiled-crush-map&quot;</span><br><span class="line">crushtool -d &quot;compiled-crush-map&quot; -o &quot;crush-map&quot;</span><br></pre></td></tr></table></figure>

<p>接著修改 <code>crush-map</code> 檔案內容，應該會有一行有 <code>step chooseleaf</code> 開頭的設定，把最後的
type 從 <code>host</code> 調整為 <code>osd</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Before</span></span><br><span class="line">step chooseleaf firstn &lt;number&gt; type host</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">After</span></span><br><span class="line">step chooseleaf firstn &lt;number&gt; type osd</span><br></pre></td></tr></table></figure>

<p>最後將修改好的 crush map 設定塞回去。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crushtool -c &quot;crush-map&quot; -o &quot;compiled-crush-map&quot;</span><br><span class="line">ceph osd setcrushmap -i &quot;compiled-crush-map&quot;</span><br></pre></td></tr></table></figure>

<p>相關 reference link</p>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.ceph.com/en/latest/rados/configuration/common/">Common Settings — Ceph Documentation</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://access.redhat.com/documentation/en-us/red_hat_ceph_storage/1.2.3/html/installation_guide_for_centos_x86_64/create_a_cluster">Chapter 4. Create a Cluster Red Hat Ceph Storage 1.2.3 | Red Hat Customer Portal</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.ceph.com/en/latest/rados/operations/crush-map/">CRUSH Maps — Ceph Documentation</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.ceph.com/en/latest/rados/operations/crush-map-edits/">Manually editing a CRUSH Map — Ceph Documentation</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.ceph.com/en/latest/rados/operations/crush-map/">CRUSH Maps — Ceph Documentation</a></li>
</ul>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>筆者在公司業務並不負責維護 production 的 Ceph cluster，僅是為了建立 Kubernetes
開發環境，需要有個基本會動的 Ceph。</p>
<p>為了用最少資源建立 Ceph 環境，需要調整相關設定來改變 Ceph 行為。
只可惜相關的資源不是很夠，一路跌跌撞撞下來，決定寫下這篇筆記，希望造福未來的自己，也同時照顧他人。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-07-28T16:23:00.000Z" title="7/28/2021, 4:23:00 PM">2021-07-29</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/28/nats-brief-intro.html">NATS 與 JetStream 簡易介紹</a></p><div class="content"><p>最近因公司業務在玩一套相對新的 MQ: NATS。
因為官方文件不慎清楚且有些地方與直覺不同，造成起步緩慢。</p>
<p>以下簡單紀錄一下剛入門時應知道的事情。</p>
<h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><p>相較 RabbitMQ, Kafka 等，<a target="_blank" rel="noopener external nofollow noreferrer" href="https://nats.io/">NATS</a> 是一套較為年輕的 MQ。
雖然有部分子專案的版本未達 v1.0，但官方宣稱已經接近 production ready。</p>
<p>NATS 從一開始就是針對 cloud service 設計，cluster mode 的水平擴展，
node 之間的身分驗證及 TLS 通訊設計看起來都還不錯。</p>
<p>NATS 的 message 並無特別限制，在 client library 內任何的 byte sequence 都可以成為 message。</p>
<p>NATS 有以下三個模式(以及其對應的 client library)。</p>
<h3 id="NATS-NATS-Core"><a href="#NATS-NATS-Core" class="headerlink" title="NATS (NATS Core)"></a>NATS (NATS Core)</h3><p>NATS 專案從一開始發展時的基本模式。 支援 <strong>Pub&#x2F;Sub</strong> pattern 並提供 <code>at-most-once</code> 語意。</p>
<h3 id="NATS-Streaming"><a href="#NATS-Streaming" class="headerlink" title="NATS Streaming"></a>NATS Streaming</h3><p>NATS Streaming 是一套疊在 NATS 上面形成的 solution。</p>
<p>因為設計上的問題，後來又有了 JetStream，所以我們基本上不用理它，只要知道 NATS Streaming 和
JetStream 不一樣，翻文件的時候不要翻錯即可。</p>
<h3 id="JetStream"><a href="#JetStream" class="headerlink" title="JetStream"></a>JetStream</h3><p>JetStream 是後來做在 NATS 內，可選擇是否啟用的子系統。 藉由 JetStream，
可以實作 <strong>Producer&#x2F;Consumer</strong> pattern 並提供 <code>at-least-once</code> 語意。</p>
<p>Server side 沒什麼需要注意的，只要用較新版的 NATS image 並啟用設定即可。
Client 開發則需要注意一些概念。</p>
<ul>
<li>Subject: NATS 最初的概念，代表一些 message 的集合。</li>
<li>Stream: 建立於一或多個 Subject 之上，可將這些 subject 內的 message 統整起來，並放入 persistent storage。</li>
<li>Consumer: 建立在某個 Stream 之下，可以依序的 consume 屬於此 stream 的特定 message。</li>
</ul>
<p>需要注意的是，不只 Subject 與 Stream，Consumer 本身也是建立在 NATS server 中的一個物件。
當利用 client library create 一個 Consumer 時，並不是該 process 本身成為一個 consumer，
而是 NATS server 中被創了一個 Consumer 物件，準備去使用 Stream 裡面的 message。</p>
<p>JetStream client library 並沒有提供一個對稱的 producer&#x2F;consumer API。
基於術語的限制以及為了避免誤會，以下在稱呼一般所稱的 producer&#x2F;consumer 時，
會特別加上 <strong>role</strong> 後綴來表示。</p>
<p>Producer role: 要使用 NATS library 內的 Publish API，將產生的 message 推送至
某個 Subject 內。</p>
<p>Consumer role: 要使用 JetStream library 內的 Stream API，在 NATS server 上對目標
Subject 建立 Stream，接著使用 JetStream Consumer API，在 NATS server 中
建立屬於該 Stream 的 Consumer。以上都完成之後，即可利用 Consumer 上的 <code>NextMsg</code> 來
消耗 message。</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>JetStream 的 API 設計並不常見，需要先認知到與既有設計的差別之處才能開始開發。
不過其 cloud native 的架構設計或許可以在維運上面勝過其他老牌的 MQ solution。</p>
<p>今天就先寫到這裡，如果有哪天有興趣再補吧。 :D</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://gcoolinfo.medium.com/comparing-nats-nats-streaming-and-nats-jetstream-ec2d9f426dc8">Comparing NATS, NATS Streaming and NATS JetStream | by George Koulouris | Medium</a></li>
</ul>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><p>Golang sample code:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/nats-io/jsm.go&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/nats-io/jsm.go/api&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/nats-io/nats.go&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fullSubject <span class="type">string</span> = <span class="string">&quot;report_task.scheduled&quot;</span></span><br><span class="line"><span class="keyword">var</span> wildcardSubject <span class="type">string</span> = <span class="string">&quot;report_task.*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consumeOne</span><span class="params">(doneChan <span class="keyword">chan</span> <span class="type">bool</span>)</span></span> &#123;</span><br><span class="line">	msg, err := consumer.NextMsg()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Fail to get message: %v\n&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Consume get task: %s\n&quot;</span>, <span class="type">string</span>(msg.Data))</span><br><span class="line">	time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">	<span class="keyword">if</span> err := msg.Ack(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Fail to ack the message %s: %v\n&quot;</span>, <span class="type">string</span>(msg.Data), err)</span><br><span class="line">	&#125;</span><br><span class="line">	doneChan &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestProduceAndConsume</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	producerStopChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line">	consumerStopChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line">	<span class="keyword">var</span> taskCount <span class="type">int</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> idx := <span class="number">0</span>; idx &lt; taskCount; idx++ &#123;</span><br><span class="line">			taskName := fmt.Sprintf(<span class="string">&quot;task #%d&quot;</span>, rand.Int())</span><br><span class="line">			nc.Publish(fullSubject, []<span class="type">byte</span>(taskName))</span><br><span class="line"></span><br><span class="line">			fmt.Printf(<span class="string">&quot;Producer produce: %s\n&quot;</span>, taskName)</span><br><span class="line">		&#125;</span><br><span class="line">		producerStopChan &lt;- <span class="literal">true</span></span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> idx := <span class="number">0</span>; idx &lt; taskCount; idx++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			consumeOne(consumerStopChan)</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&lt;-producerStopChan</span><br><span class="line">	<span class="keyword">for</span> idx := <span class="number">0</span>; idx &lt; taskCount; idx++ &#123;</span><br><span class="line">		&lt;-consumerStopChan</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ctx context.Context</span><br><span class="line"><span class="keyword">var</span> cancel context.CancelFunc</span><br><span class="line"><span class="keyword">var</span> nc *nats.Conn</span><br><span class="line"><span class="keyword">var</span> stream *jsm.Stream</span><br><span class="line"><span class="keyword">var</span> consumer *jsm.Consumer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setup</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	ctx, cancel = context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</span><br><span class="line">	nc, err = nats.Connect(nats.DefaultURL, nats.UserInfo(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;password&quot;</span>), nats.UseOldRequestStyle())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jsmgr, err := jsm.New(nc)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	streamName := <span class="string">&quot;ReportTask&quot;</span></span><br><span class="line">	stream, err = jsmgr.LoadOrNewStreamFromDefault(streamName,</span><br><span class="line">		api.StreamConfig&#123;</span><br><span class="line">			Subjects:     []<span class="type">string</span>&#123;wildcardSubject&#125;,</span><br><span class="line">			Storage:      api.FileStorage,</span><br><span class="line">			Retention:    api.LimitsPolicy,</span><br><span class="line">			Discard:      api.DiscardOld,</span><br><span class="line">			MaxConsumers: <span class="number">-1</span>,</span><br><span class="line">			MaxMsgs:      <span class="number">-1</span>,</span><br><span class="line">			MaxBytes:     <span class="number">-1</span>,</span><br><span class="line">			MaxAge:       <span class="number">24</span> * time.Hour,</span><br><span class="line">			MaxMsgSize:   <span class="number">-1</span>,</span><br><span class="line">			Replicas:     <span class="number">1</span>,</span><br><span class="line">			NoAck:        <span class="literal">false</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	consumerName := <span class="string">&quot;Generator&quot;</span></span><br><span class="line">	consumer, err = stream.LoadOrNewConsumerFromDefault(consumerName,</span><br><span class="line">		api.ConsumerConfig&#123;</span><br><span class="line">			Durable:         consumerName,</span><br><span class="line">			DeliverPolicy:   api.DeliverNew,</span><br><span class="line">			FilterSubject:   fullSubject,</span><br><span class="line">			AckPolicy:       api.AckExplicit,</span><br><span class="line">			AckWait:         <span class="number">30</span> * time.Second,</span><br><span class="line">			MaxDeliver:      <span class="number">5</span>,</span><br><span class="line">			ReplayPolicy:    api.ReplayInstant,</span><br><span class="line">			SampleFrequency: <span class="string">&quot;0%&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">shutdown</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cancel()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestMain</span><span class="params">(m *testing.M)</span></span> &#123;</span><br><span class="line">	setup()</span><br><span class="line">	code := m.Run()</span><br><span class="line">	shutdown()</span><br><span class="line">	os.Exit(code)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-06-06T13:00:00.000Z" title="6/6/2021, 1:00:00 PM">2021-06-06</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/06/github-pages-gitlab-pages.html">GitHub Pages 與 GitLab Pages 架設 Blog</a></p><div class="content"><p>筆者最近把個人 blog 的產生工具從 GitHub Pages 預設的 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://jekyllrb.com/">Jekyll</a>
換成 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io/">Hexo</a>，有了一點心得。 而且不只 GitHub Pages，
筆者在公司業務中也有大量使用 GitLab Pages 來產生文件及測試報表，算是有累積不少經驗。</p>
<p>趁著印象還深刻時，寫點筆記，替這兩個相同性質的服務做基本的介紹。</p>
<h2 id="Pages-服務與-Static-Site-Generator"><a href="#Pages-服務與-Static-Site-Generator" class="headerlink" title="Pages 服務與 Static Site Generator"></a>Pages 服務與 Static Site Generator</h2><p>GitHub &#x2F; GitLab Pages 可以將一組靜態網頁內容 (html, css, js 等)，透過 GitHub &#x2F; GitLab
的伺服器，host 在某個 URL 底下。 網頁產生工具 (Static Site Generator, 下稱 SSG) 則是
一個可以將用 Markdown 撰寫的文章，轉化成漂亮的靜態網頁內容的工具。常見的 SSG 有 Jekyll(Ruby), Hugo(Go),
Hexo(JavaScript) 等。</p>
<p>若將 SSG 工具與 GitHub &#x2F; GitLab Pages 服務，搭配使用，
<strong>寫作者只需要寫寫簡單的 Markdown 並 push commit，就能得到一個漂亮的 blog 或是文件網頁。</strong>
筆者的個人 blog 及公司的工作筆記即是使用這類流程架設。</p>
<p>整體流程大概如下圖所示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">               +   GitHub            +     github.io</span><br><span class="line">Local Project  |          Project    |               site</span><br><span class="line">               |   GitLab            |     gitlab.io</span><br><span class="line">               +                     +</span><br><span class="line"></span><br><span class="line">+----------+        +----------+  Build &amp;  +------+  User</span><br><span class="line">| Markup   |  Push  | Markup   |  Deploy   | Site |  Browse</span><br><span class="line">| config.. | +----&gt; | Config.. | +-------&gt; |      | +-------&gt;</span><br><span class="line">+----------+        +----------+           +------+</span><br></pre></td></tr></table></figure>

<h2 id="GitHub-Pages"><a href="#GitHub-Pages" class="headerlink" title="GitHub Pages"></a>GitHub Pages</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://pages.github.com/">GitHub Pages</a> 基本上會有兩種主要的使用方式。
可以直接使用 GitHub Pages，或是透過 GitHub Pages 的 Jekyll 整合功能。
前者需要的技術背景與設定步驟均較複雜，後者較簡單但缺少了根據個別需求調整的機會。</p>
<h3 id="Native-GitHub-Pages"><a href="#Native-GitHub-Pages" class="headerlink" title="Native GitHub Pages"></a>Native GitHub Pages</h3><p>若直接使用 GitHub Pages，使用方式是: 將 SSG 產生的網頁擺放至某 branch (預設為 <code>gh-pages</code>)
的 <code>/</code> 或 <code>/docs</code> 目錄。 每次該 branch 被更新時，GitHub 就會將最新版本的網頁內容，
呈現在 <code>https://&lt;username&gt;.github.io/&lt;project&gt;</code> 連結下。</p>
<p>早期這個 push brach 的動作是蠻麻煩的，但後來有了 GitHub Action 之後，
產生網站和後 push branch 的動作都可以在 GitHub 提供的環境完成，非常方便。</p>
<p>筆者個人使用的 job 描述檔如下:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/blog.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">build-and-deploy-blog</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">&quot;master&quot;</span> ]</span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">blog:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-20.04</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2.3.4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Node.js</span> <span class="string">environment</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v2.1.5</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="number">12.</span><span class="string">x</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependent</span> <span class="string">packages</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">blog</span> <span class="string">posts</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./public</span></span><br></pre></td></tr></table></figure>

<p>若不想使用 GitHub 提供的 domain，也可以參照
<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site">官方文件</a>，
使用自己購買的 domain 來架設網站。
只要設定完成，GitHub 也可以一併幫使用者申請 custom domain 需要的 HTTPS 憑證。</p>
<p>比方說筆者的 blog 原本可存取的位置應是 <code>https://wdhongtw.github.io/blog</code>，但有設定
custom domain 後，目前是透過 <code>https://blog.bitisle.net</code> 來存取架在 GitHub Pages 上的 blog。</p>
<p><img src="/assets/images/f0b7ac13-d964-496f-ab78-1fed9a8a742b.png"></p>
<h3 id="GitHub-Pages-Jekyll"><a href="#GitHub-Pages-Jekyll" class="headerlink" title="GitHub Pages Jekyll"></a>GitHub Pages Jekyll</h3><p>前述 (Native) GitHub Pages 的使用方式會需要自己 push branch。
但若 GitHub 偵測到 project 使用的 SSG 是 Jekyll，GitHub 會自動處理產生網頁以及
後續部屬到 <code>https://&lt;username&gt;.github.io/&lt;project&gt;</code> 的工作。
(連 <code>gh-pages</code> branch 都省了，整個 project 會非常乾淨。)</p>
<p>此方法相當容易上手，也是 GitHub Pages 教學文件預設的使用方式。但因為產生網站的
環境是由 GitHub 協助處理，能使用的 Jekyll plugin 自然也是受到限制。</p>
<p>說是受到限制，但以一般使用情境應該也很夠了。諸如 RSS feed, sitemap, Open Graph metadata
等現代 blog 必備的功能都有自帶。
若想知道有那些 Jekyll plugin 可用，可至 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://pages.github.com/versions/">Dependency versions | GitHub Pages</a>
查閱。</p>
<h3 id="Compare-Native-GitHub-Page-with-GitHub-Pages-and-Jekyll"><a href="#Compare-Native-GitHub-Page-with-GitHub-Pages-and-Jekyll" class="headerlink" title="Compare Native GitHub Page with GitHub Pages and Jekyll"></a>Compare Native GitHub Page with GitHub Pages and Jekyll</h3><p>簡單比較上述兩種方式如下</p>
<table>
<thead>
<tr>
<th></th>
<th>GitHub Page</th>
<th>GitHub Page with Jekyll</th>
</tr>
</thead>
<tbody><tr>
<td>SSG Tool</td>
<td>on your choice</td>
<td>only Jekyll</td>
</tr>
<tr>
<td>Deployment</td>
<td>push generated site</td>
<td>done by GitHub</td>
</tr>
<tr>
<td>Customization</td>
<td>any plugins of SSG</td>
<td>limited Jekyll plugin list</td>
</tr>
</tbody></table>
<h2 id="GitLab-Pages"><a href="#GitLab-Pages" class="headerlink" title="GitLab Pages"></a>GitLab Pages</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://about.gitlab.com/stages-devops-lifecycle/pages/">GitLab Pages</a>
與 GitHub Pages 一樣，有將 SSG 產生的網頁 host 在特定網址的能力。
以 GitLab 官方 host 的站台來說，網站會放在 <code>https://&lt;username&gt;.gitlab.io/&lt;project&gt;</code> 下。
(私人或公司 host 的 GitLab instance 就要看各自的設定)</p>
<p>與 GitHub 不同的是，GitLab Pages 並不是透過 push branch 的方式部屬，
且沒有針對特定 SSG 提供更進一步的自動部屬功能。</p>
<p>GitLab Pages 的使用方式是基於 GitLab CI Pipeline 的架構設計的。若想要部屬
網站，一般的使用方式是在 pipeline 內產生網頁，接著將網頁內容擺放至為特定 job (<code>pages</code>) 的特定
artifacts 目錄 (<code>public</code>) 中。 一旦有 pipeline jobs 達成此條件。 GitLab 就會
把網頁內容部屬到對應的網址下。</p>
<p>筆者個人使用的 job 描述檔如下:
(因為 GitHub Action 與 GitLab CI 的架構差異，寫起來比較簡潔)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .gitlab-ci.yml</span></span><br><span class="line"><span class="attr">pages:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">ruby:3.0.1</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">before_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bundle</span> <span class="string">install</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">jekyll</span> <span class="string">build</span> <span class="string">--destination</span> <span class="string">public</span> <span class="string">--baseurl</span> <span class="string">&quot;$CI_PAGES_URL&quot;</span></span><br><span class="line">  <span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<p>至於其他 GitHub Pages 有的功能，如 custom domain，自動申請 HTTPS 憑證等，GitLab Pages
也都有。 記得去 project 設定頁面設定即可。</p>
<p><img src="/assets/images/49f9611b-3d40-4425-beb6-317aeae0aa6e.png"></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>在 2008 年 GitHub Pages 剛推出時，使用者都要自己手動 push <code>gh-pages</code> branch。
後來 GitLab 推出基於 GitLab CI 的 Pages 服務之後，GitHub Pages
使用體驗相較之下可說是非常糟糕。</p>
<p>但後來隨著 GitHub Actions 服務推出，以及社群維護的高品質
<a target="_blank" rel="noopener" href="https://github.com/marketplace/actions/github-pages-action">Pages 部屬 Action</a> 出現。
GitHub &#x2F; GitLab Pages 的使用體驗已經變得相當接近。
其他像是 custom domain 以及 HTTPS 的支援也都是免費的基本功能。</p>
<p>基於上述原因，許多早期的 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://mjswensen.com/blog/github-pages-vs-gitlab-pages/">比較文章</a>
其實已經沒什麼參考價值。 若現在想架設新的 blog 等站台，只要選擇自己習慣的平台即可。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.github.com/en/pages">GitHub Pages Documentation - GitHub Docs</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.gitlab.com/ee/user/project/pages/">GitLab Pages | GitLab</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-05-11T00:00:00.000Z" title="5/11/2021, 12:00:00 AM">2021-05-11</time></span><span class="level-item"><a class="link-muted" href="/categories/notes/">notes</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/11/github-ssh-fido-key.html">GitHub 即日起支援使用 Security Key 進行 Git 操作</a></p><div class="content"><p>GitHub 開始支援使用 security key 進行 Git 操作啦！</p>
<p>這應該是各家科技巨頭當中，第一個支援 security key 進行 SSH login 的服務吧。
筆者昨天 5&#x2F;10 才在公司內分享如何使用 security key 來做 SSH login，
沒想到 Yubico 和 GitHub 也剛好在昨天一起同步更新 blog 文章，通知大家這個新功能。
喜極而泣..</p>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.blog/2021-05-10-security-keys-supported-ssh-git-operations/">Security keys are now supported for SSH Git operations - The GitHub Blog</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yubico.com/blog/github-now-supports-ssh-security-keys/">GitHub now supports SSH security keys - Yubico</a></li>
</ul>
<p>以下簡單介紹如何使用這個新功能。
為了方便解說及避免誤會，後述內容均以正式名稱 authenticator 代稱 security key。</p>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>首先當然要有一把 authenticator，如果還沒有，趕快去買一把囉。 :D</p>
<p><strong>第一步</strong>，在 authenticator 內產生新的 key pair。</p>
<p>產生 key pair 的流程和傳統放在檔案系統上的差不多，只是 key type 要指定代表 authenticator
的 type。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ecdsa-sk</span><br></pre></td></tr></table></figure>

<p>產生的過程，根據不同的 authenticator，會有要求按一下 且&#x2F;或 輸入 PIN code 驗證身分。
此步驟會在 authenticator 內產生一組 key pair，並將 public key 寫到檔案系統上。
平常放 private key 的那個檔案還是會產生，不過這次裡面放的會是一個 key handle。</p>
<p><strong>第二步</strong>，透過 GitHub 的 web UI 上傳 public key</p>
<p>上傳完之後，沒意外就可以順利使用了，可以試著 clone 一些 project</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git clone git@github.com:github/secure_headers.git</span><br><span class="line">Cloning into &#x27;secure_headers&#x27;...</span><br><span class="line">Confirm user presence for key ECDSA-SK SHA256:........</span><br><span class="line">User presence confirmed</span><br></pre></td></tr></table></figure>

<p>若確認 OK，之後的 Git 操作都可以透過隨身攜帶的 authenticator 保護，
只要按一下 authenticator 即可。</p>
<p>設定完之後，<strong>若沒有拿出 authenticator，就不能進行 push &#x2F; pull 操作。</strong>
只要確保 authenticator 還在身上，就可以安心睡大覺。
(再也不用擔心 private key 放在公司電腦上會被摸走了！)</p>
<h2 id="進階使用方式"><a href="#進階使用方式" class="headerlink" title="進階使用方式"></a>進階使用方式</h2><p>FIDO 2 authenticator 博大精深，除了上述的基本使用流程外，還有些細節可以設定。</p>
<p>以下分別介紹三個進階使用技巧：</p>
<h3 id="要求身分驗證-User-Verification-才能使用-Authenticator"><a href="#要求身分驗證-User-Verification-才能使用-Authenticator" class="headerlink" title="要求身分驗證 (User Verification) 才能使用 Authenticator"></a>要求身分驗證 (User Verification) 才能使用 Authenticator</h3><p>根據每個人平常保管鑰匙習慣的差異，可能有人會擔心 authenticator 真的被摸走。</p>
<p>但 authenticator 也有支援一定要驗甚身分 (e.g. PIN code or 指紋辨識) 後才能
使用內部的 key pair 的功能。</p>
<p>要如何使用呢？ 只要在產生 key pair 的過程中多下一個 flag 即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ecdsa-sk -O verify-required</span><br></pre></td></tr></table></figure>

<p>若之後要使用由此方式產生的 key pair，除了手指按一下 authenticator 之外，還會要求
使用者輸入 PIN code 才能順利完成操作。如此即使 authenticator 被偷走了，也不用太緊張。</p>
<h3 id="全自動使用-Authenticator-避免-User-Presence-Check"><a href="#全自動使用-Authenticator-避免-User-Presence-Check" class="headerlink" title="全自動使用 Authenticator (避免 User Presence Check)"></a>全自動使用 Authenticator (避免 User Presence Check)</h3><p>若把 authenticator 插上電腦後，想要隨時隨地都進行 push &#x2F; pull，
但不要每次都手按一下 authenticator。這種自動化的使用情境 OpenSSH 其實也是有支援的。</p>
<p>使用的方式也是在產生 key pair 時多帶一個參數。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ecdsa-sk -O no-touch-required</span><br></pre></td></tr></table></figure>

<p>同時在將 public key 部屬到目標機器上時，在 public key 該行前面多下 <code>no-touch-required</code>
即可。 (詳情請見 <code>ssh-keygen(1)</code> 及 <code>sshd(8)</code>)</p>
<p>以此方始產生的 key pair 在使用時就不需要每次都手按一下，可以全自動使用。</p>
<p>不過，雖然 OpenSSH 有支援此種使用情境，<strong>但目前 GitHub 禁止這種使用方式</strong>。</p>
<p>節錄自上述 blog 文章</p>
<blockquote>
<p>While we understand the appeal of removing the need for the taps,
we determined our current approach to require presence and intention
is the best balance between usability and security.</p>
</blockquote>
<p>所以在 GitHub 上，若想要全自動操作，只能回去用一般的 SSH key 或 API token 囉。</p>
<h3 id="避免手動複製-Key-Handle"><a href="#避免手動複製-Key-Handle" class="headerlink" title="避免手動複製 Key Handle"></a>避免手動複製 Key Handle</h3><p>前面有提到，原先檔案系統上用來放 private key 的檔案會變成拿來擺放 key handle。</p>
<p>這意味著，當我們想在新的機器上透過 SSH 進行 Git 操作時，除了拿出 authenticator 之外，
也需要把原先的 key handle 檔案複製到新的機器上。
且若 key handle 檔案掉了，該組 key pair 就不能使用了。</p>
<p>若要避免此問題，就要用上 authenticator 的另一個進階功能
discoverable credentials &#x2F; resident keys 。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ecdsa-sk -O resident</span><br></pre></td></tr></table></figure>

<p>使用此類型的 key pair 時，會在 authenticator 上消耗一些儲存空間。但換來的好處是，
使用者可以在新的機器上，把 key handle 從 authenticator 內抽出來。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -K # extract discoverable credentials</span><br></pre></td></tr></table></figure>

<p>如此就不用手動複製擺放 key handle 的 private key 檔案了。</p>
<p>但要注意的是此類型 key pair 會消耗 authenticator 的空間。
每把 authenticator 可以放多少 key pair 要再自行查閱官方文件。</p>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>以上介紹了基本使用情境及三種可能的進階使用方式。</p>
<p>筆者在 2014 年第一次注意到 FIDO (U2F) 標準，當時就在想像沒有密碼的世界。
如今，藉由 FIDO 2 security key 的普及，當初所想的美好願景似乎在慢慢地實現中..</p>
<p>希望未來能看到 security key 運用在更多場景上！</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/categories/notes/page/0/">Previous</a></div><div class="pagination-next"><a href="/categories/notes/page/2/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/categories/notes/">1</a></li><li><a class="pagination-link" href="/categories/notes/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/16065489" alt="Weida"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Weida</p><p class="is-size-6 is-block">Researcher &amp; Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Taiwan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">27</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">39</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/wdhongtw" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/wdhongtw"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://www.facebook.com/wdhongtw"><i class="fab fa-facebook"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/news/"><span class="level-start"><span class="level-item">news</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/notes/"><span class="level-start"><span class="level-item">notes</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/tips/"><span class="level-start"><span class="level-item">tips</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-06-28T13:22:00.000Z">2025-06-28</time></p><p class="title"><a href="/2025/06/28/easier-shpool.html">Make shpool Easier to Use</a></p><p class="categories"><a href="/categories/tips/">tips</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-02-26T01:05:00.000Z">2025-02-26</time></p><p class="title"><a href="/2025/02/26/cpp-generator-crtp.html">Easier Iteration with Generator</a></p><p class="categories"><a href="/categories/notes/">notes</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-02-04T14:10:00.000Z">2025-02-04</time></p><p class="title"><a href="/2025/02/04/javascript-proxy.html">The Backbone of Frontend Framework</a></p><p class="categories"><a href="/categories/notes/">notes</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-25T22:25:00.000Z">2024-11-26</time></p><p class="title"><a href="/2024/11/25/cpp-blank-identifier.html">The True Placeholder Symbol in C++</a></p><p class="categories"><a href="/categories/news/">news</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-23T00:15:00.000Z">2024-10-23</time></p><p class="title"><a href="/2024/10/23/cpp-optional-monostate.html">There is No Unit Type in C++</a></p><p class="categories"><a href="/categories/notes/">notes</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2025/"><span class="level-start"><span class="level-item">2025</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/"><span class="level-start"><span class="level-item">2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/"><span class="level-start"><span class="level-item">2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/"><span class="level-start"><span class="level-item">2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/authentication/"><span class="tag">authentication</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/blog/"><span class="tag">blog</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/c/"><span class="tag">c</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ceph/"><span class="tag">ceph</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/community/"><span class="tag">community</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpp/"><span class="tag">cpp</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/development/"><span class="tag">development</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/email/"><span class="tag">email</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fido/"><span class="tag">fido</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/functional/"><span class="tag">functional</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/generic/"><span class="tag">generic</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/github/"><span class="tag">github</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gitlab/"><span class="tag">gitlab</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gnupg/"><span class="tag">gnupg</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/golang/"><span class="tag">golang</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ide/"><span class="tag">ide</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript/"><span class="tag">javascript</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jekyll/"><span class="tag">jekyll</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubernetes/"><span class="tag">kubernetes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/log/"><span class="tag">log</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mq/"><span class="tag">mq</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nats/"><span class="tag">nats</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rfc/"><span class="tag">rfc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/samba/"><span class="tag">samba</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/secret/"><span class="tag">secret</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/security/"><span class="tag">security</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/socks/"><span class="tag">socks</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spell/"><span class="tag">spell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemd/"><span class="tag">systemd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/terminal/"><span class="tag">terminal</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/testing/"><span class="tag">testing</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/typing/"><span class="tag">typing</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vim/"><span class="tag">vim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="Bitisle" height="28"></a><p class="is-size-7"><span>&copy; 2025 Weida Hong</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener external nofollow noreferrer">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener external nofollow noreferrer" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener external nofollow noreferrer" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/wdhongtw/blog"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><a id="back-to-top" title="Back to top" href="javascript:;" rel="external nofollow noreferrer"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;" rel="external nofollow noreferrer">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>